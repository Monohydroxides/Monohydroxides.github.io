<head>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
</head>

## 4.1 网络层概述
主要任务：把分组从源端传送到目的端，为分组交换网上的不同主机提供通信服务。

网络层的传输单位是分组。

功能：路由选择与分组转发，异构网络互联，拥塞控制（开环控制与闭环控制）。

**网络层要设计得尽量简单，向其上层只提供简单灵活的，无连接的，尽最大努力交付的数据报服务**。

## 4.2 IP 数据报
### 4.2.1 IP 数据报格式
IP 数据报格式分为首部和数据部分（TCP、UDP 段）
首部分为固定部分（20 字节）和可变部分。
固定部分按顺序，各个信息如下：

4 位版本字段，指定 IP 协议的版本。

4 位首部长度，单位是 4B，最少为 5（因为首部的固定部分为 20 字节）。

8 位区分服务，指期望获得服务的类型。

16 位总长度，单位为 1B。

16 位标识，为一个计数器，每产生一个数据报就加 1，并赋值给标识字段。当一个数据报长度超过网络 MTU 时，必须分片，每个数据报片都复制一次标识号，以便能重装出原来的数据报。

3 位标志。标志分片信息 MF，是否允许分片 DF。

13 位片偏移，指出较长的分组在分片后，某片在原分组中的相对位置。以 8 个字节为偏移单位，除最后一个分片外，每个分片的长度一定是 8B 的整数倍。

8 位生存时间（TTL），数据报在网络中可通过的路由器数最大值，路由器在转发分组前先把 TTL - 1，避免分组在网络中循环。

8 位协议，指出分组携带的数据所使用的协议。值为 6 表示 TCP，值为 17 表示 UDP 等。

16 位首部校验和，对分组的首部进行校验。

4 Byte 源地址，标识发送方的 IP 地址。

4 Byte 目标地址，标识接收方的 IP 地址。

可变部分中的可选字段在 0 - 40B，用以支持其他操作，需要填充 0 把首部补为 4B 的整数倍。

### 4.2.2 IP 数据报分片
最大传输单元 MTU：数据链路层的数据帧可以封装数据的上限，以太网的 MTU 为 1500 字节。

IP 数据报中的固定部分中，同一数据报的分片使用同一标识。

3 位标志只有两位有意义，中间位 DF（Don't Fragment），当 DF = 1 时禁止分片，DF = 0 时允许分片，最低为 MF（More Fragment），当 MF = 1 表示后面还有分片，MF = 0 时表示是最后一片或没分片。

13 位片偏移，指出较长的分组分片之后某片在原分组中的相对位置，单位为 8B。

### 4.2.3 IPv4 地址
连接到 Internet 的每台主机（或路由器）都分配一个 32 比特的全球唯一标识符，即 IP 地址，它由互联网名字和数字地址分配机构 ICANN 进行分配。

**分类的 IP 地址**

A 类：首位为 0，1B 网络号，3B 主机号

B 类：首两位为 10，2B 网络号，2B 主机号

C 类：首三位为 110，3B 网络号，1B 主机号

D 类：首四位为 1110，为多播地址

E 类：首四位为 1111，保留今后使用。

**特殊的 IP 地址**

0.0.0.0，可以作为源地址，不能作为目的地址，本网范围内表示主机，路由表中表示默认路由。

255.255.255.255，不能作为源地址，可以作为目的地址，表示整个网络的广播地址。

主机号全 1 表示本网络广播地址，即直接广播地址，\*.\*.\*.255，对特定网络上的所有主机进行广播。

127.\*.\*.\*，表示环回自检地址，表示任意主机本身，目的地址为环回地址的 IP 数据报永远不会出现在任何网络上。

**私有 IP 地址**

为了网络安全，划分出了部分 IP 地址为私有 IP 地址，私有 IP 地址只用于 LAN，不用于 WAN，因此，私有 IP 地址不能直接用于 Internet，必须通过网关利用 NAT（网络地址转换）把私有 IP 地址转换为 Internet 中的合法的全球 IP 地址后才能用于 Internet，且允许私有 IP 地址被 LAN 重复使用。

在因特网中的所有路由器，对目的地址是私有地址的数据一律不进行转发，这种采用私有 IP 地址的互联网称为专用互联网或本地互联网，私有 IP 地址也称为可重用地址。

A 类：10.0.0.0 - 10.255.255.255

B 类：172.16.0.0 - 172.31.255.255

C 类：192.168.0.0 - 192.168.255.255

### 4.2.4 网络地址转换
NAT 需要在专用网连接到因特网的路由器上安装 NAT 软件，NAT 路由器至少有一个有效的外部全球 IP 地址。使用本地地址的主机和外界通信时，NAT路由器使用 NAT 转换表进行本地 IP 地址和全球 IP 地址的转换。NAT 转换表中存放着{本地 IP 地址：端口}到{全球 IP 地址：端口}的映射，通过这种映射方式，可以让多个私有 IP 地址映射到一个全球 IP 地址。

普通路由器在转发 IP 数据报时不改变源地址和目标地址，NAT 路由器在转发 IP 数据报时一定会更换其 IP 地址；普通路由器仅工作在网络层，而 NAT 路由器转发数据报时需要查看和转换传输层的端口号。

### 4.2.5 子网划分与子网掩码
两级 IP 地址导致 IP 地址空间的利用率很低，因此可以通过子网划分的方法在 IP 地址中增加一个子网号字段，使两级 IP 地址变为三级 IP 地址：{网络号，子网号，主机号}。

凡是从其他网络发送给本单位某台主机的 IP 数据报，仍然根据 IP 数据报的目的网络号，先找到连接到本单位网络上的路由器。然后该路由器在收到 IP 数据报后，按目的网络号和子网号找到目的子网。最后把 IP 数据报直接交付给目的主机。

为了告诉主机或路由器对一个 A 类，B 类，C 类网络进行了子网划分，我们需要使用子网掩码表示原网络中主机号的借位。子网掩码由一串连续的 1 后跟随的一串连续的 0 组成，1 对应 IP 地址中的网络号和子网号，0 对应主机号，计算机将 IP 地址与对应的子网掩码按位与后，即可得到对应子网的网络地址。

子网掩码是一个网络或一个子网的重要属性，路由器在交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉对方。

在使用子网掩码时：

（1）一台主机在设置 IP 地址信息的同时，必须设置子网掩码；

（2）属于同一个子网的所有主机及路由器的相应端口必须设置相同的子网掩码；

（3）路由器的路由表中，所包含的信息的主要内容有目的网络地址、子网掩码、下一跳地址。

### 4.2.6 无分类编址 CIDR
CIDR 消除了 A、B、C 类网络的划分及划分子网的概念，将 IP 地址分为网络前缀和主机号，网络前缀的位数可以任意选取，记法为 IP 地址后加上 /，然后在 / 后写上网络前缀的位数。

CIDR 地址块：网络前缀都相同的连续的 IP 地址。

路由聚合：将多个子网合成一个较大的子网，即路由表中的一个项目可以表示多个原来传统分类地址的路由，有利于减少路由器之间的信息交换，提高网络性能。

使用 CIDR 时，应采取**最长前缀匹配**，即查找路由表可能得到几个符合匹配的结果，应该选择具有最长网络前缀的路由，因为前缀越长，地址块越小，路由越具体。

### 4.2.7 ARP 协议
在网络链路上传输数据帧时，必须使用 MAC 地址。

ARP 协议：完成主机或路由器 IP 地址到 MAC 地址的
映射。

ARP 协议的使用过程：检查 ARP 高速缓存，有对应表项则写入 MAC 帧，没有则用目的 MAC 地址为 FF-FF-FF-FF-FF-FF 的帧封装并广播 ARP 请求分组，**同一局域网中的所有主机都能收到该请求**。目的主机收到请求后就会向源主机单播一个 ARP 相应分组，源主机收到后将此映射写入 ARP 缓存。ARP 缓存表 1200s 更新一次。

### 4.2.8 DHCP 协议
DHCP 协议是一个**应用层协议**，使用 C/S 方式，客户端和服务端通过**广播**的方式进行交互，基于 UDP。

DHCP 提供即插即用联网机制，主机可以从服务器动态获取 IP 地址、子网掩码、默认网关、DNS 服务器与 IP 地址，允许地址重用，支持移动用户加入网络，支持在用地址续租。

### 4.2.9 ICMP 协议
ICMP 支持主机或路由器进行差错（异常）报告，网络探询。

ICMP 报文包括：

1 字节类型，1 字节代码，2 字节检验和。
而后 4 个字节取决于 ICMP 报文的类型。
而后是 ICMP 报文的数据部分，长度取决于类型。

ICMP 报文主要有 ICMP 差错报文，ICMP 询问报文。

**ICMP 差错报告报文**

ICMP 差错报告报文一共有五种：
1. 终点不可达：当路由器或主机不能交付数据时向源点发送终点不可达报文。
2. 源点抑制：当路由器或主机由于拥塞丢弃数据报时，向源点发送源点抑制报文。
3. 时间超过：当路由器收到生存时间 TTL = 0 的数据报时，需要丢弃数据报并向源点发送时间超过报文；当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已经收到的数据报片全部丢弃，并向源点发送时间超过报文（traceroute）。
4. 参数问题：当路由器或目的主机收到的数据报的首部中有字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
5. 重定向：路由器把改变路由报文发送给主机，让主机知道下次应该将数据报发送给另外的路由器。

当使用 ICMP 差错报告报文时，需要将要进行差错报告的 IP 数据报的首部和 IP 数据报的数据字段的前 8 个字节取出作为 ICMP 差错报告报文的数据部分，再在前面加上 ICMP 的前 8 个字节形成 ICMP 差错报告报文，再在前面加上 IP 数据报的首部构成完整的数据报。

不应该发送 ICMP 差错报告报文的情况：
1. 禁止套娃。即不对 ICMP 差错报告报文发送 ICMP 差错报告报文。
2. 只对第一个分片的数据报片发送 ICMP 差错报告报文，对第一个分片的数据报片所有的后续报片都不发送 ICMP 差错报告报文。
3. 对具有组播地址的数据报都不发送 ICMP 差错报告报文。
4. 对具有特殊地址的数据报不发送 ICMP 报文。

**ICMP 询问报文**

ICMP 询问报文分为四种：
1. 回送请求和回答报文：主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文（ping）。
2. 时间戳请求和回答报文：请求某个主机或路由器回答当前日期和时间（进行时钟同步，时间测量）。
3. 掩码地址请求和回答报文：现在不再使用。
4. 路由器询问和通告报文：现在不再使用。

## 4.3 IPv6
IPv4 的地址快被用完了！我们有了 CIDR 和 NAT 给 IPv4 续命。

为了根本上解决这个问题，同时为了改进首部格式，支持 Qos，就有了 IPv6。

### 4.3.1 IPv6 数据报格式
IPv6 包括两个部分：基本首部和有效载荷。
基本首部为 40 字节，有效载荷不超过 65535 字节。

为了支持扩展，有效载荷中一开始的部分为扩展首部（根据需要可有可无），分别装载扩展首部 1，扩展首部 2，...，扩展首部 n。

基本首部按顺序，各个信息如下：

4 位版本，指明协议的版本，对于 IPv6 而言是 6。

8 位优先级，区分数据报的类别和优先级。

20 位流标签，类似于 IPv4 中的标识位，“流”是互联网络上从特定源点到特定终点的一系列数据报，所有属于同一个流的数据报都具有同样的流标签。

16 位有效载荷长度，指明 IPv6 中有效载荷的长度。

8 位下一首部信息，标识下一个扩展首部或上层协议首部。可以将下一首部信息想象为一个链表，最后一个扩展首部指向数据部分。

8 位跳数限制，相当于 IPv4 中的 TTL。

128 位源地址，128 位目的地址，分别标识发送方和接收方的 IP 地址。

IPv6 相比 IPv4 的主要区别：
1. 地址空间的扩大；
2. 移除了校验和字段，减少了每跳的处理时间；
3. 移除了 IPv4 中的可选字段，改为有效载荷中的扩展首部，更加灵活；
4. **IPv6 支持即插即用（即在 IPv4 中 DHCP 协议的工作），可以自动配置 IP 地址**；
5. IPv6 的首部长度必须是 8B 的整数倍，IPv4 的首部长度必须是 4B 的整数倍；
6. IPv6 只能在主机处分片，IPv4 可以在路由器和主机处分片（因此，我们的 ICMPv6 的差错报告报文中增加了一个分组过大的类型）；
7. IPv6 支持资源的预分配，支持实时视像等要求，保证一定的带宽和时延的应用。
8. IPv6 取消了协议字段，改成了下一个首部字段。
9. IPv6 取消了总长度字段，改成了有效载荷长度字段。
10. IPv6 取消了服务类型字段。

IPv6 的地址标识形式：冒号十六进制记法，每 4 个十六进制数为一组写在一起，一共 8 组，组间使用冒号分隔开。

### 4.3.2 IPv6 基本地址类型
IPv6 基本地址类型主要分为三种：单播，多播，任播。

单播为一对一通信，可以作为源地址和目的地址。

多播为一对多通信，可以作为目的地址。

任播为一对多中的一个通信，实质为一对一通信，可以作为目的地址。

### 4.3.3 IPv4 向 IPv6 过渡
IPv4 向 IPv6 过渡的过程中采用两种策略：双栈协议和隧道技术。

双栈协议：在一台设备上同时启用 IPv4 协议栈和 IPv6 协议栈。如果这个设备是路由器，那么这台路由器的不同接口上分别配置了 IPv4 地址和 IPv6 地址，并分别连接 IPv4 网络和 IPv6 网络；如果这个设备是计算机，那么这个计算机将同时拥有 IPv4 地址和 IPv6 地址。

隧道技术：通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据或负载可以是不同协议的数据帧或包，隧道协议将其他协议的数据帧或包重新封装后通过隧道发送。

## 4.4 路由算法与路由协议
### 4.4.1 路由算法

路由算法分为静态路由算法（非自适应路由算法）和动态路由算法（自适应路由算法），他们的区别主要为配置路由信息的方式，静态路由算法由管理员手工配置路由信息，动态路由算法由路由器间彼此交换信息，按照路由算法优化出路由表项。

其中，动态路由算法中，主要分为全局的和分散的两类，他们的区别主要在于每个路由器对网络拓扑和链路费用的掌握情况，全局的动态路由算法的代表为**链路状态路由算法（OSPF 协议）**，分散的动态路由算法的代表为**距离向量路由算法（RIP 协议）**。

### 4.4.2 分层次的路由选择协议
由于因特网规模很大，且很多单位不想让外界知道自己的路由选择协议的同时还想连入互联网，这时候就需要使用分层次的路由选择协议。

我们把因特网分成一个个自治系统 AS，这是在单一的技术管理下的一组路由器，这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由协议以确定 AS 之间的路由。

路由选择协议分为内部网关协议 IGP（一个 AS 内所使用的协议，如 RIP、OSPF）和外部网关协议 EGP（AS 之间使用，如 BGP）。

### 4.4.3 RIP 协议与距离向量算法
RIP 协议是一种分布式的，基于**距离向量**的路由选择协议，是因特网的协议标准，它要求每个路由器都维护从他自己到其他每一个目的网络的唯一最佳距离记录。**RIP 是应用层协议，使用 UDP 传送数据**。

路由表中一般有三项，分别为目的网络、距离（跳数）和下一跳的路由器。

RIP 允许一条路由最多包含 15 个路由器，因此 16 条数表示网络不可达，也正因如此，RIP 协议只适用于小型互联网。

RIP 协议只和相邻的路由器交换自己的全部路由表，每 30 秒交换一次，如果 180 秒内没有收到邻居路由器的交换信息，则认为邻居路由器已经不在该网络中。

在开始时，每个路由器只知道直连网络的距离为 1，经过若干次交换后，所有路由器都会知道道道本自治系统下的任何一个网络的最短距离和下一跳路由器的地址。

距离向量算法修改路由表的过程可以被概括为谁发来的路由表，该路由表表项的下一跳目的地址就写谁并把距离 +1，如果此时路由表项中同一地址的网络有距离更小的，那就忽略。

### 4.4.4 RIP 协议的报文格式
RIP 报文由首部和路由部分构成。首部主要包括命令和版本，路由部分由地址族标识符，路由标记，网络地址，子网掩码，下一跳的路由器地址和距离组成。

一个 RIP 报文的每个路由信息使用 20 个字节，最多可以包括 25 个路由。如果超过 25 个路由，必须再用一个 RIP 报文传送。

由于 RIP 协议的更新不是同步的，因此可能在同步路由表的过程中出现套娃的问题（收敛慢），我以为你可以到，你以为我可以到，实则二者都不能到达目的网络却在互相更新对方的路由表，这种套娃会直到两个路由表到目的网络的距离都增大到 16 才会停止。

### 4.4.5 OSPF 协议与链路状态算法
OSPF：open shortest path first，其最主要的特征是使用分布式的链路状态协议。

OSPF 使用 BFS 的方法向 AS 内的所有路由器发送信息，与所有路由器交换与本路由器相邻的所有路由器的链路状态（拓扑结构、度量代价），这个广播信息的过程只有在链路状态发生变化时才会发生（当然，还需要每隔 30 min 刷新一次）。

链路状态路由算法
1. 每个路由器发现邻居节点【HELLO 问候分组】，并了解邻居节点的网络地址；
2. 设置到它的每个邻居的成本度量 metric。
3. 构造【DD 数据库描述分组】，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
4. 如果 DD 分组中的摘要自己都有则不做处理，如果没有或者有更新，则发送【LSR 链路状态请求分组】请求自己没有的和比自己更新的信息。
5. 收到邻站的 LSR 分组后，发送【LSU 链路状态更新分组】进行更新。
6. 更新完毕后，邻站返回一个【LSAck 链路状态确认分组】进行确认。

当一个路由器的链路状态发生变化时：
1. BFS 发送【LSU 链路状态更新分组】进行更新。
2. 更新完毕后，其他站返回【LSAck 链路状态确认分组】进行确认。
3. 每个路由器使用 Dijkstra 算法根据自己的链路状态数据库构造到其他节点间的最短路。

为了使 OSPF 适用于规模更大的网络，OSPF 会将一个 AS 内划分为若干个更小的区域，每个区域用一个 32 位的区域标识符（点分十进制表示）。

OSPF 是**网络层协议**，直接使用 IP 数据报传送。

### 4.4.6 BGP 协议
BGP 协议中，每个 AS 选择至少一个路由器作为该 AS 的 BGP 发言人，一个 BGP 发言人可以通过建立 TCP 连接与其他 AS 中的 BGP 交换路由信息（即 BGP 报文是 TCP 报文的数据部分，即 BGP 是应用层协议），然后在此连接上交换 BGP 报文以建立 BGP 会话，利用 BGP 会话交换路由信息。所有 BGP 发言人都相互交换网络可达性信息后，各个 BGP 发言人就可以找到到达各个自治系统的较好路由。

BGP 交换路由信息的节点数量级是 AS 的数量级，要比 AS 中的网络数量少，每个 AS 中的 BGP 发言人是很少的。

BGP 支持 CIDR。

常用的 BGP-4 共使用四种报文：
1. 打开报文（open），用来和相邻的另一个 BGP 发言人建立关系，并认证发送方。
2. 更新报文（update），用来发送某一路由的信息，以及列出要撤销的多条路由。
3. 保活报文（keepalive），用来确认打开报文并周期性证实邻站关系。
4. 通知报文（notification），用来发送检测到的差错。

### 4.5 IP 组播
IP 组播地址让源设备能够将分组发送给一组设备，属于多播组的设备将被分配一个组播组的 IP 地址，他们即为一群共同需求的逐句地相同标识。

组播的地址范围即为 IPv4 的 D 类地址，一个 D 类地址表示一个组播组。

源地址总是为单播地址。

组播数据报为“最大努力交付”，即应用于 UDP，对组播数据报不产生 ICMP 差错报告报文。

但由于有些 D 类地址已经被指派，所以并非所有 D 类地址都可以作为组播地址。

组播分为硬件组播、因特网范围内组播，前者只能在本局域网内组播，后者在因特网范围内组播。

**硬件组播**

组播 IP 地址也需要相应的组播 MAC 地址在本地网络中实际传送帧。组播 MAC 地址以十六进制的 01-00-5E 开头，余下的 6 个十六进制位是根据 IP 组播组地址最后 23 位转换得到的。

TCP/IP 协议使用的以太网多播地址范围：01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF。

**IGMP 协议**

IGMP 使用 IP 数据报传送报文，在工作时，当某主机要加入组播组时，该主机向组播组的组播地址发送一个 IGMP 报文，声明自己要称为该组的成员，本地组播路由器收到 IGMP 报文后，要利用组播路由选择协议把这组成员的关系发给因特网上的其他组播路由器。

同时，本地组播路由器周期性的探询本地局域网上的主机，以便知道这些主机是否还是组播组的成员，只要有一个主机对某个组响应，那么组播路由器就认为这个组是活跃的，否则，在经过几次探询之后没有一个主机响应，组播路由器就认为本网络上没有此组播组的主机，就不再把这组的成员关系发送给其他组播路由器。

**组播路由选择协议**

组播路由选择协议的目的是找出与源主机为根节点的组播转发树。

组播路由选择协议主要使用基于链路状态的路由选择、基于距离向量的路由选择或协议无关的组播（PIM）。

## 4.6 移动 IP
移动 IP 技术是指移动节点以固定的网络 IP 地址，实现跨越不同网段的漫游功能，并保证了基于网络 IP 的网络权限在漫游的过程中不发生改变。

本地代理：一个移动节点所在的网络成为归属网络，归属网络中代表移动节点执行移动管理功能的实体叫本地代理。

外地代理：在外部网络中帮助移动节点完成移动管理功能的实体。

永久地址：即移动 IP 技术中提到的固定的网络 IP 地址。

转交地址：移动站点在外部网络中使用的临时地址。

在某一主机进入外部网络时，该主机在外地代理登记获得一个转交地址，离开时注销，完成该过程后向本地代理登记转交地址；当有主机给该主机发送数据报时，本地代理会截获数据报，并重新封装为目的地址是转交地址的数据报，发送给外地代理，外地代理将数据报拆封后发回该主机。

该过程可以类比于快递地址登记过程，发回了原来的地址就让在原来地址的人帮忙转发给自己；但在发送数据报时不用那么麻烦，可以想象为直接填了个假的发货地址（即该主机直接使用自己的主地址作为数据报源地址）进行通信。

## 4.7 网络层设备

**路由器**

路由器是一个具有多个输入输出端口的专用计算机，任务为转发分组。

路由选择：构造、更新、维护路由表；

分组转发：根据路由表对分组进行转发。